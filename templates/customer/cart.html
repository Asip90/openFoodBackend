<!-- Panier Flottant -->
<div id="cart-sidebar" class="fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-40">
    <div class="h-full flex flex-col">
        <!-- Header du panier -->
        <div class="p-6 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">Votre Commande</h2>
                <button onclick="toggleCart()" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <p class="text-gray-500 text-sm mt-1">Table {{ table.number }}</p>
        </div>
        
        <!-- Contenu du panier -->
        <div id="cart-content" class="flex-1 overflow-y-auto p-6">
            {% if cart %}
                {% for item_id, item_data in cart.items %}
                <div class="cart-item flex items-center space-x-4 py-4 border-b border-gray-100" data-item-id="{{ item_id }}">
                    <div class="flex-shrink-0">
                        {% if item_data.image %}
                        <img src="{{ item_data.image }}" alt="{{ item_data.name }}" 
                             class="h-16 w-16 object-cover rounded-lg">
                        {% else %}
                        <div class="h-16 w-16 bg-gray-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-utensils text-gray-300"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-medium text-gray-900 truncate">{{ item_data.name }}</h4>
                        <p class="text-sm text-primary font-medium">{{ item_data.price }}€</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="updateCartItem('{{ item_id }}', {{ item_data.quantity|add:'-1' }})" 
                                class="h-8 w-8 flex items-center justify-center rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span class="text-sm font-medium min-w-8 text-center">{{ item_data.quantity }}</span>
                        <button onclick="updateCartItem('{{ item_id }}', {{ item_data.quantity|add:'1' }})" 
                                class="h-8 w-8 flex items-center justify-center rounded-full border border-gray-300 text-gray-600 hover:bg-gray-50 transition-colors duration-200">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                        <button onclick="removeCartItem('{{ item_id }}')" 
                                class="h-8 w-8 flex items-center justify-center rounded-full border border-gray-300 text-gray-600 hover:bg-red-50 hover:text-red-600 transition-colors duration-200 ml-2">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-12">
                <i class="fas fa-shopping-basket text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500">Votre panier est vide</p>
                <p class="text-gray-400 text-sm mt-2">Ajoutez des plats pour commencer</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer du panier -->
        <div class="border-t border-gray-100 p-6 bg-gray-50">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-700 font-medium">Total</span>
                <span id="cart-total" class="text-xl font-bold text-primary">{{ cart_total|floatformat:2 }}€</span>
            </div>
            
            <div class="space-y-3">
                <a href="{% url 'checkout' table_token %}" 
                   id="checkout-btn"
                   class="block w-full bg-primary text-white py-3 rounded-lg text-center font-medium hover:opacity-90 transition-opacity duration-300 {% if cart_count == 0 %}opacity-50 cursor-not-allowed{% endif %}"
                   {% if cart_count == 0 %}disabled{% endif %}>
                    <i class="fas fa-check-circle mr-2"></i>
                    Commander
                </a>
                
                <button onclick="toggleCart()"
                        class="block w-full border border-gray-300 text-gray-700 py-3 rounded-lg text-center font-medium hover:bg-gray-50 transition-colors duration-300">
                    Continuer mes achats
                </button>
            </div>
            
            <p class="text-gray-400 text-xs text-center mt-3">
                <i class="fas fa-lock mr-1"></i>
                Commande sécurisée
            </p>
        </div>
    </div>
</div>

<!-- Overlay pour le panier -->
<div id="cart-overlay" 
     class="fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 pointer-events-none transition-opacity duration-300"
     onclick="toggleCart()"></div>

<script>
    // Gestion de l'état du panier
    window.cartSidebarOpen = false;
    
    function toggleCart() {
        const sidebar = document.getElementById('cart-sidebar');
        const overlay = document.getElementById('cart-overlay');
        
        if (sidebar.classList.contains('translate-x-full')) {
            sidebar.classList.remove('translate-x-full');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-50', 'pointer-events-auto');
            document.body.style.overflow = 'hidden';
            window.cartSidebarOpen = true;
            
            // Rafraîchir le contenu du panier
            refreshCartItems();
        } else {
            sidebar.classList.add('translate-x-full');
            overlay.classList.remove('opacity-50', 'pointer-events-auto');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = 'auto';
            window.cartSidebarOpen = false;
        }
    }
    
    // Fermer le panier avec Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && window.cartSidebarOpen) {
            toggleCart();
        }
    });
</script>

{% comment %} 
    Ce template est conçu pour être une modal incluse dans `base.html` ou `menu.html`.
    Il sera affiché/masqué via JavaScript.
{% endcomment %}
{% comment %} 
<div id="cart-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-transform duration-300 ease-out scale-95 modal-content">
        <!-- En-tête du panier -->
        <div class="flex justify-between items-center border-b border-gray-200 p-6 bg-gray-50 rounded-t-lg">
            <h2 class="text-3xl font-bold text-gray-800">Votre Panier</h2>
            <button onclick="closeModal('cart-modal')" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Corps du panier - Liste des articles -->
        <div id="cart-items-container" class="p-6 space-y-4">
            {% if cart %}
                {% for item_id, item_data in cart.items %}
                    <div id="cart-item-{{ item_id }}" class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex items-center space-x-4">
                            {% if item_data.image %}
                                <img src="{{ item_data.image }}" alt="{{ item_data.name }}" class="w-16 h-16 object-cover rounded-md shadow-sm">
                            {% else %}
                                <div class="w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10l-2 2h20l-2-2V7m0 0H4m0 0V5a2 2 0 012-2h12a2 2 0 012 2v2M4 7h16" />
                                    </svg>
                                </div>
                            {% endif %}
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">{{ item_data.name }}</h3>
                                <p class="text-md text-gray-600 font-medium">{{ item_data.price }}€</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center border border-gray-300 rounded-lg p-1">
                                <button onclick="updateCart('{{ item_id }}', 'decrement')" class="px-2 py-1 text-gray-600 hover:text-primary-color transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 10a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <span id="item-qty-{{ item_id }}" class="mx-2 text-lg font-medium text-gray-800 w-6 text-center">{{ item_data.quantity }}</span>
                                <button onclick="updateCart('{{ item_id }}', 'increment')" class="px-2 py-1 text-gray-600 hover:text-primary-color transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                            <button onclick="updateCart('{{ item_id }}', 'remove')" class="text-red-500 hover:text-red-700 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-gray-600 text-lg py-8">Votre panier est vide.</p>
            {% endif %}
        </div>

        <!-- Pied du panier - Total et Bouton de commande -->
        <div class="p-6 bg-gray-50 rounded-b-lg border-t border-gray-200">
            <div class="flex justify-between items-center text-2xl font-bold text-gray-800 mb-4">
                <span>Total :</span>
                <span id="cart-total-price">{{ cart_total|floatformat:2 }}€</span>
            </div>
            <a href="{% url 'checkout' table_token=table_token %}" class="block w-full text-center bg-primary-color text-white py-4 rounded-lg text-xl font-bold hover:bg-opacity-90 transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-primary-color focus:ring-opacity-50">
                Commander
            </a>
        </div>
    </div>
</div>

<script>
    function updateCart(itemId, action) {
        let currentQtyElement = $(`#item-qty-${itemId}`);
        let currentQty = parseInt(currentQtyElement.text());
        let newQty = currentQty;

        if (action === 'increment') {
            newQty += 1;
        } else if (action === 'decrement') {
            newQty -= 1;
        } else if (action === 'remove') {
            newQty = 0; // Set to 0 to remove
        }

        $.ajax({
            url: `{% url 'update_cart' table_token=table_token %}`,
            type: 'POST',
            data: JSON.stringify({ 
                item_id: itemId, 
                action: (action === 'remove' || newQty === 0) ? 'remove' : 'update', 
                quantity: newQty 
            }),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    // Update global cart display
                    updateCartDisplay(response.total, response.count);
                    $('#cart-count-mobile').text(response.count);

                    if (action === 'remove' || newQty === 0) {
                        $(`#cart-item-${itemId}`).remove(); // Remove item from display
                    } else {
                        currentQtyElement.text(newQty); // Update quantity display
                    }
                    $('#cart-total-price').text(response.total.toFixed(2) + '€'); // Update modal total

                    // If cart is empty, show the "empty cart" message
                    if (response.count === 0) {
                        $('#cart-items-container').html('<p class="text-center text-gray-600 text-lg py-8">Votre panier est vide.</p>');
                    }
                } else {
                    alert('Erreur lors de la mise à jour du panier.');
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX error: ", status, error);
                alert('Une erreur est survenue.');
            }
        });
    }
</script> {% endcomment %}