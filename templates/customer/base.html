<!-- customer/base.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ restaurant.name }} - Menu{% endblock %}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '{{ customization.primary_color|default:"#1a1a1a" }}',
                        secondary: '{{ customization.secondary_color|default:"#d4af37" }}',
                    },
                    fontFamily: {
                        custom: ['{{ customization.font_family|default:"Inter" }}', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family={{ customization.font_family|default:"Inter"|urlencode }}:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        body {
            font-family: '{{ customization.font_family|default:"Inter" }}', sans-serif;
        }
        .loading {
            display: none;
        }
        .loading.active {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 font-custom">
    <!-- Navbar -->
    {% include 'customer/navbar.html' %}
    
    <!-- Content -->
    <main>
        {% block content %}{% endblock %}
    </main>
    
    <!-- Footer -->
    {% include 'customer/footer.html' %}
    
    <!-- Cart Modal -->
    <div id="cartModal" class="hidden fixed inset-0 z-50 overflow-hidden">
        {% include 'customer/cart_modal.html' %}
    </div>
    
    <!-- Item Details Modal -->
    <div id="itemModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
        {% include 'customer/menu_detail_modal.html' %}
    </div>
    
    <!-- Scripts -->
    <script>
        // Données initiales
        const initialData = {
            cart: {{ cart_json|safe }},
            cartTotal: {{ cart_total|default:0 }},
            cartCount: {{ cart_count|default:0 }},
            restaurantId: {{ restaurant.id }},
            tableToken: '{{ table_token }}',
            csrfToken: '{{ csrf_token }}'
        };
        
        // Fonctions utilitaires
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            notification.textContent = message;
            notification.style.animation = 'fadeIn 0.3s ease-in-out';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-in-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function formatPrice(price) {
            return parseFloat(price).toFixed(2) + ' €';
        }
    </script>
    
    <!-- Script principal -->
    <script >
        // static/js/menu.js
document.addEventListener('DOMContentLoaded', function() {
    // Éléments DOM
    const cartModal = document.getElementById('cartModal');
    const itemModal = document.getElementById('itemModal');
    const cartCountEl = document.getElementById('cartCount');
    const cartTotalEl = document.getElementById('cartTotal');
    const cartItemsEl = document.getElementById('cartItems');
    
    // État
    let cart = initialData.cart || [];
    let cartTotal = initialData.cartTotal || 0;
    let cartCount = initialData.cartCount || 0;
    let currentItem = null;
    
    // Mettre à jour l'affichage du panier
    function updateCartDisplay() {
        if (cartCountEl) cartCountEl.textContent = cartCount;
        if (cartTotalEl) cartTotalEl.textContent = formatPrice(cartTotal);
        
        if (cartItemsEl) {
            cartItemsEl.innerHTML = '';
            
            if (cart.length === 0) {
                cartItemsEl.innerHTML = `
                    <div class="text-center py-12">
                        <i class="ri-shopping-cart-line text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Votre panier est vide</p>
                    </div>
                `;
            } else {
                cart.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between py-4 border-b border-gray-100';
                    itemEl.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden">
                                ${item.image ? 
                                    `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">` :
                                    `<div class="w-full h-full flex items-center justify-center">
                                        <i class="ri-image-line text-gray-400"></i>
                                    </div>`
                                }
                            </div>
                            <div>
                                <h4 class="font-medium">${item.name}</h4>
                                <p class="text-sm text-gray-500">${formatPrice(item.price)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="flex items-center border border-gray-300 rounded-lg">
                                <button onclick="updateQuantity('${item.id}', ${item.quantity - 1})" 
                                        class="px-3 py-1 hover:bg-gray-100">
                                    <i class="ri-subtract-line"></i>
                                </button>
                                <span class="px-3">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.id}', ${item.quantity + 1})" 
                                        class="px-3 py-1 hover:bg-gray-100">
                                    <i class="ri-add-line"></i>
                                </button>
                            </div>
                            <button onclick="removeFromCart('${item.id}')" 
                                    class="text-red-500 hover:text-red-700">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                    `;
                    cartItemsEl.appendChild(itemEl);
                });
            }
        }
    }
    
    // AJAX Helper
    async function ajaxRequest(url, data) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': initialData.csrfToken
            },
            body: JSON.stringify(data)
        });
        return await response.json();
    }
    
    // Ajouter au panier
    window.addToCart = async function(itemId, button) {
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="ri-loader-4-line animate-spin"></i>';
        }
        
        try {
            const result = await ajaxRequest(`/t/${initialData.tableToken}/cart/`, {
                action: 'add',
                item_id: itemId
            });
            
            if (result.success) {
                // Recharger la page pour voir les updates
                location.reload();
            } else {
                showNotification('Erreur lors de l\'ajout au panier', 'error');
            }
        } catch (error) {
            showNotification('Erreur réseau', 'error');
        } finally {
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="ri-shopping-cart-line"></i> Ajouter';
            }
        }
    }
    
    // Mettre à jour la quantité
    window.updateQuantity = async function(itemId, quantity) {
        if (quantity < 1) {
            await removeFromCart(itemId);
            return;
        }
        
        try {
            const result = await ajaxRequest(`/t/${initialData.tableToken}/cart/`, {
                action: 'update',
                item_id: itemId,
                quantity: quantity
            });
            
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            showNotification('Erreur de mise à jour', 'error');
        }
    }
    
    // Retirer du panier
    window.removeFromCart = async function(itemId) {
        try {
            const result = await ajaxRequest(`/t/${initialData.tableToken}/cart/`, {
                action: 'remove',
                item_id: itemId
            });
            
            if (result.success) {
                location.reload();
            }
        } catch (error) {
            showNotification('Erreur de suppression', 'error');
        }
    }
    
    // Afficher les détails d'un item
    window.showItemDetails = async function(itemId) {
        try {
            const response = await fetch(`/item/${itemId}/details/`);
            const data = await response.json();
            
            if (data.success) {
                currentItem = data.item;
                showItemModal();
            }
        } catch (error) {
            showNotification('Erreur de chargement', 'error');
        }
    }
    
    // Modal functions
    window.showCartModal = function() {
        updateCartDisplay();
        cartModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    window.hideCartModal = function() {
        cartModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    window.showItemModal = function() {
        if (!currentItem) return;
        
        const modalContent = document.getElementById('itemModalContent');
        if (modalContent) {
            modalContent.innerHTML = `
                <div class="bg-white rounded-2xl overflow-hidden">
                    <!-- Image -->
                    <div class="h-64 bg-gray-100 overflow-hidden">
                        ${currentItem.image_url ? 
                            `<img src="${currentItem.image_url}" alt="${currentItem.name}" class="w-full h-full object-cover">` :
                            `<div class="w-full h-full flex items-center justify-center">
                                <i class="ri-image-line text-4xl text-gray-400"></i>
                            </div>`
                        }
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-2xl font-bold">${currentItem.name}</h3>
                                <p class="text-gray-600">${currentItem.category}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-secondary">
                                    ${formatPrice(currentItem.discount_price || currentItem.price)}
                                </p>
                                ${currentItem.discount_price ? 
                                    `<p class="text-sm text-gray-400 line-through">${formatPrice(currentItem.price)}</p>` : ''
                                }
                            </div>
                        </div>
                        
                        ${currentItem.description ? `
                            <div class="mb-6">
                                <h4 class="font-bold mb-2">Description</h4>
                                <p class="text-gray-700">${currentItem.description}</p>
                            </div>
                        ` : ''}
                        
                        ${currentItem.ingredients ? `
                            <div class="mb-6">
                                <h4 class="font-bold mb-2">Ingrédients</h4>
                                <p class="text-gray-700">${currentItem.ingredients}</p>
                            </div>
                        ` : ''}
                        
                        ${currentItem.allergens ? `
                            <div class="mb-6">
                                <h4 class="font-bold mb-2">Allergènes</h4>
                                <p class="text-gray-700">${currentItem.allergens}</p>
                            </div>
                        ` : ''}
                        
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            ${currentItem.is_vegetarian ? 
                                '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Végétarien</span>' : ''
                            }
                            ${currentItem.is_vegan ? 
                                '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Vegan</span>' : ''
                            }
                            ${currentItem.is_spicy ? 
                                '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">Épicé</span>' : ''
                            }
                        </div>
                        
                        <!-- Action -->
                        <button onclick="addToCart('${currentItem.id}')" 
                                class="w-full bg-secondary text-white py-3 rounded-lg font-medium hover:opacity-90 transition-opacity">
                            <i class="ri-shopping-cart-line"></i> Ajouter au panier
                        </button>
                    </div>
                </div>
            `;
        }
        
        itemModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    window.hideItemModal = function() {
        itemModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    
    // Fermer les modals en cliquant à l'extérieur
    cartModal.addEventListener('click', function(e) {
        if (e.target === cartModal) hideCartModal();
    });
    
    itemModal.addEventListener('click', function(e) {
        if (e.target === itemModal) hideItemModal();
    });
    
    // Initialiser l'affichage
    updateCartDisplay();
});
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>