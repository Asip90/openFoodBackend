{% extends "admin_user/base.html" %}

{% block title %}Modifier un plat – OpenFood{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-4 md:p-6">

  <!-- En-tête -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-3">
      <a href="{% url 'menus_list' %}" 
         class="text-gray-400 hover:text-gray-600 transition-colors duration-150">
        <i class="fas fa-arrow-left"></i>
      </a>
      <div>
        <h1 class="text-xl font-semibold text-gray-900">
          Modifier le plat
        </h1>
        <p class="text-sm text-gray-500 mt-0.5">
          Restaurant : {{ restaurant.name }}
        </p>
      </div>
    </div>
  </div>

  <!-- Formulaire -->
  <div class="bg-white rounded-lg border border-gray-100 p-6">
    <form method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      <!-- Nom -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Nom du plat
        </label>
        <input type="text" name="name" required
          value="{{ menu_item.name }}"
          class="w-full px-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg
                 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"
          placeholder="Ex : Poulet braisé">
      </div>

      <!-- Catégorie -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Catégorie
        </label>
        <div class="flex gap-2">
          <select name="category" id="categorySelect" required
            class="flex-1 px-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg
                   focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
            <option value="" class="text-gray-400">Sélectionner une catégorie</option>
            {% for category in categories %}
              <option value="{{ category.id }}"
                {% if menu_item.category_id == category.id %}selected{% endif %}
                class="text-gray-700">
                {{ category.name }}
              </option>
            {% endfor %}
          </select>
          <button type="button" onclick="openCategoryModal()"
            class="px-4 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors duration-150">
            +
          </button>
        </div>
      </div>

      <!-- Prix -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Prix (FCFA)
        </label>
        <input type="number" name="price" step="0.01" required
          value="{{ menu_item.price }}"
          class="w-full px-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg
                 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"
          placeholder="2500">
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Description
        </label>
        <textarea name="description" rows="3"
          class="w-full px-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg
                 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary
                 placeholder:text-gray-400"
          placeholder="Description du plat (facultatif)">{{ menu_item.description }}</textarea>
      </div>

      {% comment %} <!-- Image -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Image du plat
        </label>
        
        <!-- Aperçu de l'image actuelle -->
        {% if menu_item.image %}
          <div class="mb-4">
            <div class="relative inline-block">
              <div class="w-32 h-32 rounded-lg overflow-hidden border border-gray-200">
                <img src="{{ menu_item.image.url }}" 
                     alt="{{ menu_item.name }}"
                     class="w-full h-full object-cover">
              </div>
              <div class="mt-2 text-xs text-gray-500">
                Image actuelle
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Zone de téléchargement -->
        <div class="mt-1">
          <label for="image-upload" class="cursor-pointer">
            <div class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-lg hover:border-primary/50 transition-colors duration-150">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="fas fa-cloud-upload-alt text-gray-300 text-xl mb-2"></i>
                <p class="text-xs text-gray-500">
                  {% if menu_item.image %}
                    Cliquez pour changer l'image
                  {% else %}
                    Cliquez pour télécharger une image
                  {% endif %}
                </p>
                <p class="text-xs text-gray-400 mt-1">PNG, JPG, WEBP jusqu'à 5MB</p>
              </div>
              <input id="image-upload" type="file" name="image" accept="image/png,image/jpeg,image/webp"
                     class="hidden">
            </div>
          </label>
          <p class="text-xs text-gray-400 mt-2">
            Laisser vide pour conserver l'image actuelle
          </p>
        </div>
      </div> {% endcomment %}
      <label class="block text-sm font-medium text-gray-700 mb-2">
  Image du plat
</label>

{% if menu_item.image %}
  <div class="mb-4">
    <div class="w-32 h-32 rounded-lg overflow-hidden border">
      <img src="{{ menu_item.image.url }}"
           class="w-full h-full object-cover">
    </div>
    <p class="text-xs text-gray-500 mt-1">Image actuelle</p>
  </div>
{% endif %}

<label for="image-upload" class="cursor-pointer block">
  <div id="upload-preview"
       class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-200 rounded-lg hover:border-primary/50">
    <i class="fas fa-cloud-upload-alt text-gray-300 text-xl mb-2"></i>
    <p class="text-xs text-gray-500">
      Cliquez pour changer l’image
    </p>
    <p class="text-xs text-gray-400 mt-1">PNG, JPG, WEBP</p>
  </div>
</label>

<input
  id="image-upload"
  type="file"
  name="image"
  accept="image/png,image/jpeg,image/webp"
  class="hidden">

<p class="text-xs text-gray-400 mt-2">
  Laisser vide pour conserver l’image actuelle
</p>

      <!-- Actions -->
      <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-100">
        <a href="{% url 'menus_list' %}"
           class="px-4 py-2.5 text-sm font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-150">
          Annuler
        </a>
        <button type="submit"
          class="px-4 py-2.5 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90 transition-colors duration-150">
          Mettre à jour
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de création de catégorie -->
<div id="categoryModal"
  class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 hidden">
  
  <div class="bg-white rounded-lg border border-gray-200 p-6 w-full max-w-md transform transition-all duration-200 scale-95 opacity-0">
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">
        Nouvelle catégorie
      </h2>
      <input type="text" id="categoryName"
        class="w-full px-4 py-2.5 text-sm bg-white border border-gray-200 rounded-lg
               focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary
               placeholder:text-gray-400"
        placeholder="Nom de la catégorie">
      <p class="text-xs text-gray-400 mt-2">
        La catégorie sera ajoutée et sélectionnée automatiquement.
      </p>
    </div>

    <div class="flex items-center gap-3">
      <button onclick="closeCategoryModal()"
        class="flex-1 px-4 py-2.5 text-sm font-medium text-gray-700 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-150">
        Annuler
      </button>
      <button onclick="submitCategory()"
        class="flex-1 px-4 py-2.5 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90 transition-colors duration-150">
        Créer
      </button>
    </div>
  </div>
</div>

<script>
// Gestion de la modal de catégorie
let categoryModal = document.getElementById('categoryModal');
let modalContent = categoryModal.querySelector('div');

function openCategoryModal() {
  categoryModal.classList.remove('hidden');
  setTimeout(() => {
    modalContent.classList.remove('scale-95', 'opacity-0');
  }, 10);
}

function closeCategoryModal() {
  modalContent.classList.add('scale-95', 'opacity-0');
  setTimeout(() => {
    categoryModal.classList.add('hidden');
    document.getElementById('categoryName').value = '';
  }, 200);
}

// Fermer la modal en cliquant en dehors
categoryModal.addEventListener('click', (e) => {
  if (e.target === categoryModal) {
    closeCategoryModal();
  }
});

// Fermer avec la touche Échap
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && !categoryModal.classList.contains('hidden')) {
    closeCategoryModal();
  }
});

// Fonction pour soumettre la nouvelle catégorie
function submitCategory() {
  const name = document.getElementById('categoryName').value.trim();
  
  if (!name) {
    alert('Veuillez saisir un nom pour la catégorie');
    return;
  }

  // Récupérer le token CSRF
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // Envoyer la requête AJAX
  fetch("{% url 'create_category_modale' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({ name: name })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Erreur réseau');
    }
    return response.json();
  })
  .then(data => {
    if (data.error) {
      alert(data.error);
      return;
    }

    // Ajouter la nouvelle catégorie au select
    const select = document.getElementById('categorySelect');
    const option = document.createElement('option');
    option.value = data.id;
    option.textContent = data.name;
    option.selected = true;
    
    select.appendChild(option);
    
    // Réinitialiser et fermer la modal
    document.getElementById('categoryName').value = '';
    closeCategoryModal();
    
    // Afficher un message de succès
    const successMsg = document.createElement('div');
    successMsg.className = 'fixed top-4 right-4 px-4 py-2 bg-green-50 text-green-700 text-sm rounded-lg border border-green-200 z-50';
    successMsg.textContent = 'Catégorie ajoutée avec succès';
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
      successMsg.remove();
    }, 3000);
  })
  .catch(error => {
    console.error('Erreur:', error);
    alert('Une erreur est survenue lors de la création de la catégorie');
  });
}

// Aperçu de la nouvelle image sélectionnée
document.getElementById('image-upload').addEventListener('change', function (e) {
  const file = e.target.files[0]
  if (!file) return

  const reader = new FileReader()
  reader.onload = function (event) {
    document.getElementById('upload-preview').innerHTML = `
      <img src="${event.target.result}"
           class="w-full h-full object-cover rounded-lg"
           alt="Aperçu">
    `
  }
  reader.readAsDataURL(file)
})

</script>
{% endblock %}
{% comment %} {% extends "admin_user/base.html" %}

{% block title %}Modifier un plat – OpenFood{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">

  <!-- Titre -->
  <div class="mb-8">
    <h1 class="text-2xl font-semibold text-dark">
      Modifier le plat
    </h1>
    <p class="text-gray-500 mt-1">
      Restaurant : {{ restaurant.name }}
    </p>
  </div>

  <!-- Formulaire -->
  <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-8">
    <form method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      <!-- Nom -->
      <div>
        <label class="block text-sm font-medium mb-2">
          Nom du plat
        </label>
        <input type="text" name="name" required
          value="{{ menu_item.name }}"
          class="w-full rounded-xl border border-gray-300 px-4 py-2
                 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
      </div>

      <!-- Catégorie -->
      <div>
        <label class="block text-sm font-medium mb-2">
          Catégorie
        </label>

        <div class="flex gap-2">
          <select name="category" id="categorySelect" required
            class="flex-1 rounded-xl border border-gray-300 px-4 py-2 bg-white
                   focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
            <option value="">Sélectionner une catégorie</option>
            {% for category in categories %}
              <option value="{{ category.id }}"
                {% if menu_item.category_id == category.id %}selected{% endif %}>
                {{ category.name }}
              </option>
            {% endfor %}
          </select>

          <button type="button" onclick="openCategoryModal()"
            class="px-4 rounded-xl bg-primary text-white font-semibold">
            +
          </button>
        </div>
      </div>

      <!-- Prix -->
      <div>
        <label class="block text-sm font-medium mb-2">
          Prix (FCFA)
        </label>
        <input type="number" name="price" step="0.01" required
          value="{{ menu_item.price }}"
          class="w-full rounded-xl border border-gray-300 px-4 py-2
                 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
      </div>

      <!-- Description -->
      <div>
        <label class="block text-sm font-medium mb-2">
          Description
        </label>
        <textarea name="description" rows="3"
          class="w-full rounded-xl border border-gray-300 px-4 py-2
                 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">{{ menu_item.description }}</textarea>
      </div>

      <!-- Image -->
      <div>
        <label class="block text-sm font-medium mb-2">
          Image du plat
        </label>

        {% if menu_item.image %}
          <div class="mb-3">
            <img src="{{ menu_item.image.url }}"
              class="h-32 w-32 object-cover rounded-xl border">
          </div>
        {% endif %}

        <input type="file" name="image" accept="image/*"
          class="w-full rounded-xl border border-gray-300 px-4 py-2
                 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary">
        <p class="text-xs text-gray-500 mt-1">
          Laisser vide pour conserver l’image actuelle
        </p>
      </div>

      <!-- Actions -->
      <div class="flex justify-end gap-4 pt-4">
        <a href="{% url 'menus_list' %}"
           class="px-6 py-2 rounded-xl border text-gray-600 hover:bg-gray-50">
          Annuler
        </a>

        <button type="submit"
          class="px-6 py-2 rounded-xl bg-primary text-white font-medium
                 hover:bg-green-700 transition">
          Mettre à jour
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODALE CATÉGORIE -->
<div id="categoryModal"
  class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

  <div class="bg-white rounded-2xl p-6 w-full max-w-md">
    <h2 class="text-lg font-semibold mb-4">
      Nouvelle catégorie
    </h2>

    <input type="text" id="categoryName"
      class="w-full rounded-xl border px-4 py-2 mb-4"
      placeholder="Nom de la catégorie">

    <div class="flex justify-end gap-3">
      <button onclick="closeCategoryModal()"
        class="px-4 py-2 border rounded-xl">
        Annuler
      </button>

      <button onclick="submitCategory()"
        class="px-4 py-2 bg-primary text-white rounded-xl">
        Créer
      </button>
    </div>
  </div>
</div>

<script>
function openCategoryModal() {
  document.getElementById("categoryModal").classList.remove("hidden")
  document.getElementById("categoryModal").classList.add("flex")
}

function closeCategoryModal() {
  document.getElementById("categoryModal").classList.add("hidden")
}

function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value
}

function submitCategory() {
  const name = document.getElementById("categoryName").value.trim()
  if (!name) {
    alert("Nom requis")
    return
  }

  fetch("{% url 'create_category_modale' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCSRFToken()
    },
    body: new URLSearchParams({ name })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error)
      return
    }

    const select = document.getElementById("categorySelect")
    const option = document.createElement("option")
    option.value = data.id
    option.textContent = data.name
    option.selected = true

    select.appendChild(option)

    document.getElementById("categoryName").value = ""
    closeCategoryModal()
  })
}
</script>

{% endblock %} {% endcomment %}
